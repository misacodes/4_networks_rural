---
title: "Social Network Analysis"
author: "Michaela Fricova"
date: "3/20/2023"
output: html_document
---

## #4 Social Networks in Rural South India
This project is the 4/8 part of my mini-series on social network analysis. The goal of this series is to start with the very basics of network analysis, such as with the concepts of centrality and assortativity, and progress towards more advanced topics, including Erdős-Rényi and Configuration models, as well as Exponential family random graphs. In this fourth episode, I look into the concepts of **assortativity and transitivity in rural social networks**. I analyze social ties of one rural South Indian village that was featured as village 35 in a research paper titled **Social Capital and Social Quilts: Network Patterns of Favor Exchange** by **Matthew Jackson, Tomas Rodriguez-Barraquer, and Xu Tan**. The researchers surveyed inhabitants of the village about their religion, caste and wealth (proxied by the number of rooms in their house), and also asked them **who they would go to, to borrow money or to borrow food**. Similarly, they asked the participants which fellow villages would ask them for help when in need of money or food. The central question of the present part of the mini-series is whether the exchange of food and money happens **preferentially among households from the same castes, same religions and among households with similar levels of wealth.**

```{r setup, error=FALSE, warning=FALSE, message=FALSE}
library(igraph)
# library(gplots)
library(plyr)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)
options(digits = 2)
```

## Prepping the Data
I use the adjacency matrices to make networks for each relationship type and the metadata file to assign vertex attributes to the vertices in each of those networks. More precisely, I use the attributes for caste (using the castesubcaste column in metadata file), religion (using the hohreligion column), and wealth (in this case, I am using a proxy - the room_no column, making the assumption that wealthier households have bigger houses with more rooms. The four datasets with adjacency metrices are named borrow-money, lend-money, borrow-fufo and lend-fufo. The borrow_money dataset was compiled by asking households in the village whom they would ask, if they suddenly needed to borrow Rs. 50 for a day. Conversely, the lend-money was compiled by asking the households who they would trust enough that if this person needed to borrow Rs. 50 for a day they would lend it to him/her. The Borrow-fufo and Lend-fufo datasets in similar manner ask which households would be willing to exchange kerosene or rice. Also for context, in the money borrowing and lending relationships, fifty Rupees are roughly a dollar and the per capita income in the areas surveyed is currently on the order of three dollars per day or less, although a precise income census is not available.

```{r, echo=FALSE}
attributes_village35 <- read.csv("vil35_meta.csv")
borrow_money <- read.csv("adj_borrowmoney_HH_vilno_35.csv", header=FALSE, sep=";")
lend_money <- read.csv("adj_lendmoney_HH_vilno_35.csv", header=FALSE, sep=";")
borrow_fufo <- read.csv("adj_keroricego_HH_vilno_35.csv", header=FALSE, sep=";")
lend_fufo <- read.csv("adj_keroricecome_HH_vilno_35.csv", header=FALSE, sep=";")
```

```{r}
borrow_money_g <- graph_from_adjacency_matrix(as.matrix(borrow_money), mode = "undirected")
lend_money_g <- graph_from_adjacency_matrix(as.matrix(lend_money), mode = "undirected")
borrow_fufo_g <- graph_from_adjacency_matrix(as.matrix(borrow_fufo), mode = "undirected")
lend_fufo_g <- graph_from_adjacency_matrix(as.matrix(lend_fufo), mode = "undirected")

graphs <- list(borrow_money_g, lend_money_g, borrow_fufo_g, lend_fufo_g)
for (i in 1:length(graphs)) {
  V(graphs[[i]])$caste <- attributes_village35$castesubcaste
  V(graphs[[i]])$religion <- attributes_village35$hohreligion
  V(graphs[[i]])$wealth <- attributes_village35$room_no
}

borrow_money_g <- graphs[[1]]
lend_money_g <- graphs[[2]]
borrow_fufo_g <- graphs[[3]]
lend_fufo_g <- graphs[[4]]
```

## Creating and Visualizing the Merged Network
I create one merged network by adding all the adjacency matrices together and generating a new network based on that summed adjacency matrix. I plot this network twice, once with nodes coloured by caste, and once coloured by religion, with nodes sized by wealth (number of rooms) and  edge width scaled by the number of connections the households have. A legend is included to show the label associated with each colour (so, the colour associated with each religion or each caste).


```{r}
borrow_money_adj  <- get.adjacency(borrow_money_g)
lend_money_adj  <- get.adjacency(lend_money_g)
borrow_fufo_adj  <- get.adjacency(borrow_fufo_g)
lend_fufo_adj  <- get.adjacency(lend_fufo_g)

borrow_money_adj_matrix <- as.matrix(borrow_money_adj)
lend_money_adj_matrix <- as.matrix(lend_money_adj)
borrow_fufo_adj_matrix <- as.matrix(borrow_fufo_adj)
lend_fufo_adj_matrix <- as.matrix(lend_fufo_adj)

super_matrix <- borrow_money_adj_matrix + lend_money_adj_matrix + borrow_fufo_adj_matrix + lend_fufo_adj_matrix
super_matrix_g <- graph_from_adjacency_matrix(as.matrix(super_matrix), mode = "undirected")
V(super_matrix_g)$caste <- attributes_village35$castesubcaste
as.numeric(V(super_matrix_g)$caste_num)
V(super_matrix_g)$religion <- attributes_village35$hohreligion
V(super_matrix_g)$wealth <- attributes_village35$room_no
row_super_matrix <- rowSums(super_matrix)
dlayout <- layout.fruchterman.reingold(super_matrix_g)

# graph with nodes colored by caste 
par(mar = c(2, 1, 2, 6), 
    xpd = TRUE)
plot(super_matrix_g,
     vertex.size = V(super_matrix_g)$wealth*2,
     vertex.color = V(super_matrix_g)$caste,
     vertex.label = NA,
     edge.arrow.size = 0.25, 
     edge.width=row_super_matrix*0.4,
     edge.color = "azure3",
     edge.curved = 0,
     main = "Combined network colored by caste",
     layout=dlayout)
legend("bottomright", inset = c(-0.20,-0.05),  
       legend = c("Forward Caste (General Class)", "Muslim", "Other Backwards Caste", "Scheduled Caste", "Scheduled Tribe"), 
       pch = 19, 
       col = categorical_pal(5)[c(1,2,3,4,5)],
       cex = 0.8,
       title = "Castes",
       pt.cex = 1.1)

# graph with nodes colored by religion 
par(mar = c(2, 1, 2, 6), 
    xpd = TRUE)
plot(super_matrix_g,
     vertex.size = V(super_matrix_g)$wealth*2,
     vertex.color = V(super_matrix_g)$religion,
     vertex.label = NA,
     edge.width=row_super_matrix*0.4,
     edge.color = "azure3",
     edge.curved = 0,
     main = "Combined network colored by religion",
     layout=dlayout)
legend("bottomright", inset = c(-0.20,-0.05),  
       legend = c("Hinduism", "Islam", "Christianity"), 
       pch = 19, 
       col = categorical_pal(3)[c(1,2,3)],
       cex = 0.8,
       title = "Religion",
       pt.cex = 1.1)

```

## Calculating Transitivity and Assortativity

I calculate the transitivity of each of the 4 relationship type networks. 
```{r}
t1 <- transitivity(borrow_money_g)
t2 <- transitivity(lend_money_g)
t3 <- transitivity(borrow_fufo_g)
t4 <- transitivity(lend_fufo_g)
```

Additionally, I calculate the assortativity of each of the 4 relationship type networks based on caste, religion, and wealth.  Religion and caste are categorical variables and so, for these, I will calculate modularity/homophily based on enumerative characteristics using the command assortativity.nominal(). In contrast, the number of rooms (proxy of wealth) is a continuous variable and so I will caluculate homophily based on scalar characteristics using the assortativity() command (Newman, 2010).

```{r}
a11 <- assortativity.nominal(borrow_money_g,factor(V(borrow_money_g)$caste)) 
a21 <- assortativity.nominal(lend_money_g,factor(V(lend_money_g)$caste)) 
a31 <- assortativity.nominal(borrow_fufo_g,factor(V(borrow_fufo_g)$caste)) 
a41 <- assortativity.nominal(lend_fufo_g,factor(V(lend_fufo_g)$caste)) 

a12 <- assortativity.nominal(borrow_money_g,factor(V(borrow_money_g)$religion)) 
a22 <- assortativity.nominal(lend_money_g,factor(V(lend_money_g)$religion)) 
a32 <- assortativity.nominal(borrow_fufo_g,factor(V(borrow_fufo_g)$religion)) 
a42 <- assortativity.nominal(lend_fufo_g,factor(V(lend_fufo_g)$religion)) 

a13 <- assortativity(borrow_money_g,factor(V(borrow_money_g)$wealth)) 
a23 <- assortativity(lend_money_g, V(lend_money_g)$wealth)
a33 <- assortativity(borrow_fufo_g,factor(V(borrow_fufo_g)$wealth)) 
a43 <- assortativity(lend_fufo_g,factor(V(lend_fufo_g)$wealth)) 

```

## Combining into a Dataframe
I now combine these transitivity and assortativity measures into a dataframe (so, each row will be a relationship type, with a column for each of the transitivity and assortativity measures). 

```{r}
df <- data.frame(network = c("money borrowing", "money lending", "fuel/food borrowing", "fuel/food lending"),
                 transitivity_calc  = c(t1, t2, t3, t4),
                 assortativity_caste = c(a11, a21, a31, a41),
                 assortativity_religion = c(a12, a22, a32, a42),
                 assortativity_wealth = c(a13, a23, a33, a43))
print(df)
```
## Interpreting Transitivity
```{r}
arranged_transitivity <- arrange(df, transitivity_calc)
select(arranged_transitivity, network, transitivity_calc)
```
Fuel/food lending is the most transitive relationship of the four; 27% of all triads are closed triangles in the fuel/food lending network. In other words, when 2 HHs both name a third person as someone they lend kerosene and rice to, there’s more than 1/4th chance that the 2 HHs also name each other. In contrast, money borrowing is the least transitive. Only 17% of all triads in the money borrowing network are closed triangles. Put differently, when two HHs both name a third person as someone they borrow money from, there’s a 17% chance that they also name each other.
To test how our transitivity results compare to random networks with the same number of nodes and edges as our 4 networks, I generate the following random networks:

### transitivity of a random network with equivalent characteristics as the kerosene/rice lending network 

```{r}
random_lend_fufo <- replicate(1000, transitivity(sample_gnm(n=vcount(lend_fufo_g), m=ecount(lend_fufo_g), directed = FALSE)))
hist(random_lend_fufo, col = "#CD7F32", breaks = 12, main = "histogram of transitivity values")
range(random_lend_fufo)
plot(density(random_lend_fufo), xlim=c(0,0.30), "density curve of transitivity values")
par(xpd=FALSE)
abline(v=c((transitivity(lend_fufo_g)), mean(random_lend_fufo)), col=c("blue", "red"), lty = c(2, 3))
```
 In black, the density plot outlines the null distribution of transitivity in random networks with the edge and vertex characteristics of our fuel/food lending network (Erdos-Renyi model). The mean of this null distribution of transitivity is highlighted in red. Our obtained transitivity value from the actual fuel/food lending network is in blue. There is clearly more triadic closure in the actual fuel/food lending network (i.e. more clustering of ties) than in randomly generated networks. This implies that the actual fuel/food lending network has much more triadic closure than what would be predicted by chance.

### transitivity of a random network with equivalent characteristics as the kerosene/rice borrowing network 

```{r}
random_bor_fufo <- replicate(1000, transitivity(sample_gnm(n=vcount(borrow_fufo_g), m=ecount(borrow_fufo_g), directed = FALSE)))
hist(random_bor_fufo, col = "#CD7F32", breaks = 12, main = "histogram of transitivity values")
range(random_bor_fufo)
plot(density(random_bor_fufo), xlim=c(0,0.25), main = "density curve of transitivity values")
par(xpd=FALSE)
abline(v=c((transitivity(borrow_fufo_g)), mean(random_bor_fufo)), col=c("blue", "red"), lty = c(2, 3))
```
In the observed kerosene/rice borrowing network, we again see much more triadic closure than in random networks with similar vertex and edge characteristics.

### transitivity of a network with equivalent characteristics to the money lending network 

```{r}
random_lend_money <- replicate(1000, transitivity(sample_gnm(n=vcount(lend_money_g), m=ecount(lend_money_g),directed = FALSE)))
hist(random_lend_money, col = "#CD7F32", breaks = 12, main = "histogram of transitivity values")
plot(density(random_lend_money), xlim=c(0,0.20), main = "density curve of transitivity values")
par(xpd=FALSE)
abline(v=c((transitivity(lend_money_g)), mean(random_lend_money)), col=c("blue", "red"), lty = c(2, 3))
```
In the observed money lending network, we also see much more triadic closure than in random networks with similar vertex and edge characteristics.

### transitivity of a random network with equivalent characteristics to the money borrowing network 

```{r}
random_bor_money <- replicate(1000, transitivity(sample_gnm(n=vcount(borrow_money_g), m=ecount(borrow_money_g), directed = FALSE)))
hist(random_bor_money, col = "#CD7F32", breaks = 12, main = "histogram of transitivity values")
range(random_bor_money)
plot(density(random_bor_money), xlim=c(0,0.20), "density curve of transitivity values")
par(xpd=FALSE)
abline(v=c((transitivity(borrow_money_g)), mean(random_bor_money)), col=c("blue", "red"), lty = c(2, 3))
```

Finally, the money borrowing network had the lowest transitivity of the 4 networks, the transitvity was around 17%. As before, the density plot in black outlines the null distribution of transitivity in random networks with the edge and vertex characteristics of our money borrowing network. In contrast, our obtained transitivity value from the actual money borrowing network is outlined in blue.There is clearly more triadic closure in the actual money borrowing network (i.e. more clustering of ties) than in the random network. This implies that even the money borrowing network has much more triadic closure than what would be predicted by chance.

## Interpreting Assortativity by Caste

```{r}
arranged_caste_assortativity <- arrange(df, assortativity_caste)
select(arranged_caste_assortativity, network, assortativity_caste)
```

All of the 4 favor networks exhibit positive assortative mixing by caste. This implies that there are more favor exchanges (edges) between households belonging to the same caste (e.g. Forward Caste, Scheduled Caste) than what would be predicted by chance. Of the 4 networks, kerosene/rice lending is the most assortative network by caste with modularity value of Q=0.43. And money borrowing is the least assortative by caste with modularity value of Q=0.30.

## Interpreting Assortativity by Religion

```{r}
arranged_religion_assortativity <- arrange(df, assortativity_religion)
select(arranged_religion_assortativity, network, assortativity_religion)
```

All of the 4 networks have positive assortative mixing by religion. This implies that there are more favor exchanges (edges) between households of the same religion (e.g. Muslim) than what would be predicted by chance. Money lending is the least assortative by religion with modularity value of Q=0.44. In contrast, kerosene/rice borrowing is the most assortative by religion with modularity value of Q=0.60. This could potentially indicate that different religious groups (Hindu vs. Muslim) do not exchange food in favor networks because they might have different food customs/diets. A further research focusing specifically on the high assortativity by religion in the fuel/food borrowing network would be welcome, in order to establish the underlying mechanisms.

## Interpreting Assortativity by Wealth

```{r}
arranged_wealth_assortativity <- arrange(df, assortativity_wealth)
select(arranged_wealth_assortativity, network, assortativity_wealth)
```
Of the 4 networks, fuel/food (kerosene/rice) borrowing is the most assortative by wealth. And money lending is the least assortative (most disassortative) of the 4 networks.  

## Negative Assortativity
For fuel/food and money borrowing networks, the wealth assortativity coefficient is positive, indicating homophily. In other words, there are more edges between vertices with similar amount of wealth in the kerosene/rice and money borrowing networks, relative to what we would expect by chance. The other 2 networks - money and fuel/food (kerosene/rice) lending networks have negative assortativity coefficients based on wealth, indicating heterophily. In other words, money and fuel/food lending is disassortative by wealth. This implies that 2 households which have different wealth levels are more likely to lend kerosene/rice/money to each other than 2 households which have similar wealth levels. Negative assortativity is relatively rare in social networks, since people usually tend to associate with others who are like them (Newman, 2010). However, there are some well-known examples of dissasortative matching. For example, the majority of romantic and sexual relationships are between people of the opposite sex (same-sex partnerships are less common).

## Double Sampling
Since we are considering undirected networks, transitivity and assortativity of the double sampled networks should - in theory - be the same. Fuel/food lending and borrowing networks should yield exactly the same clustering coefficients and equal values on the 3 assortatitivity measures. And, likewise, transitivity and assortativity measures should be equal for the money lending and money borrowing networks. However, we observe considerable differences in these measures due to measurement error.  Jackson et al. (2012) point out that there are several potential sources of measurement error in their data on the 75 Indian villages (of which our dataset is a subset, as it covers one of the 75 villages). Firstly, the data was collected using surveys. Generally, survey data is prone to measurement error because people often forget to mention some of their connections, they get fatigued by interviews. And specifically in this research, Jackson et al. (2012) set a cap on how many borrowers/lenders each surveyed participant can name (the survey did not allow individuals to name more than five or eight other people). This means that some households with many connections might have omitted some of their lender/borrower connections (although the authors claim that the cap was reached only in a negligible number of cases).

## 